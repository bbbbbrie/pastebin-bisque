stages:
  - preflight
  - build
  - test
  - qa
  - deploy
  - publish
  - verify
  - experimental

include:
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml

.all-but-pyver:
  when: manual
  allow_failure: true
  stage: test
  script:
    - python setup.py install
    - pip install -e .[dev]
    - pip install tox
    - tox
  artifacts:
    when: always
    reports:
      junit: coverage.xml
    paths:
      - coverage.xml
      - htmlcov/*

ğŸ§ª Python 3.9:
  extends: .all-but-pyver
  image: python:3.9

ğŸ§ª Python 3.10:
  extends: .all-but-pyver
  image: python:3.10

ğŸ§ª Python 3.11:
  image: python:3.11
  extends: .all-but-pyver

ğŸ§ª Python 3.12 rc ğŸ¥¼:
  stage: experimental
  allow_failure: true
  extends: .all-but-pyver
  image: python:3.12-rc

ğŸ§ª test with tox:
    allow_failure: false
    image: python:3.10
    stage: preflight
    script:
    - python setup.py install
    - pip install -e .[dev]
    - pip install tox
    - tox -p auto
    artifacts:
        when: always
        reports:
            junit: coverage.xml
        paths:
            - coverage.xml
            - htmlcov/*
        expire_in: 1 week

.pages:
  stage: deploy
  needs: ["ğŸ§ª test with tox"]
  script:
    - mkdir public
    - mv htmlcov/* public/
  artifacts:
    paths:
      - public/

.publish-the-package:
  needs: ["ğŸ§ª test with tox"] # Comment to speed things up. ğŸ˜¬
  image: python:latest
  stage: deploy
  before_script:
    - pip install build twine
  rules:
    - if: $CI_COMMIT_TAG =~ /v.*/

ğŸš€ deploy to ğŸ¦ŠğŸ’œ GitLab Package Registry:
  stage: publish
  extends: .publish-the-package
  script:
    - python -m build
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --verbose --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*

ğŸ§¾ check the ğŸ“¦ package ğŸ¥º:
  stage: qa
  extends: .publish-the-package
  script:
    - echo "ğŸ§¾ check the ğŸ“¦ package ğŸ¥º"
    - python -m build
    - twine check dist/*

ğŸš€ deploy to ğŸ§ª  TestPyPi:
  stage: test
  when: always
  extends: .publish-the-package
  script:
    - echo "ğŸš€ Upload to TestPyPi..."
    - python -m build
    - TWINE_USERNAME=__token__ TWINE_REPOSITORY_URL=https://test.pypi.org/legacy/ twine upload --non-interactive --comment "ğŸ¦„ hello world" --skip-existing --password $TESTPYPI_TOKEN  dist/*
  rules:
    - if: $CI_COMMIT_TAG =~ /v.*/


ğŸš€ deploy to ğŸŠ PyPi:
  needs: ["ğŸš€ deploy to ğŸ§ª  TestPyPi","ğŸ§¾ check the ğŸ“¦ package ğŸ¥º"]
  stage: publish
  when: manual
  extends: .publish-the-package
  script:
    - echo "ğŸš€ Upload to PyPi..."
    - python -m build
    - TWINE_USERNAME=__token__ TWINE_REPOSITORY_URL=https://upload.pypi.org/legacy/ twine upload --non-interactive --skip-existing --password $PYPI_TOKEN  dist/*

ğŸ˜… make sure the TestPyPi version works:
  stage: verify
  image: python:3.10
  needs: ["ğŸ§¾ check the ğŸ“¦ package ğŸ¥º"]
  script:
    - pip install -i https://test.pypi.org/simple/ pastebin-bisque==$(grep ^current_version .bumpversion.cfg | cut -d"=" -f2 | cut -d" " -f2)  --extra-index-url https://pypi.org/simple
    - pastebin-bisque --help
    - pastebin-bisque
    - pastebin-bisque -z
  artifacts:
    paths:
      - pastes/*
      - /**zip
  rules:
    - if: $CI_COMMIT_TAG =~ /v.*/

ğŸ¤ make sure the PyPi version works ğŸ€:
  stage: verify
  image: python:3.10
  script:
    - echo "ğŸ¦„ Let's do this!"
    - pip install pastebin-bisque==$(grep ^current_version .bumpversion.cfg | cut -d"=" -f2 | cut -d" " -f2)
    - pastebin-bisque --help
    - pastebin-bisque
    - pastebin-bisque --username catstestingcode
    - pastebin-bisque -z
  artifacts:
    paths:
      - pastes/*
  rules:
    - if: $CI_COMMIT_TAG =~ /v.*/
